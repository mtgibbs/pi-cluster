apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: immich-alerts
  namespace: immich
  labels:
    app.kubernetes.io/name: immich
    release: kube-prometheus  # Match Prometheus Operator selector
spec:
  groups:
    - name: immich.rules
      rules:
        # Alert if Immich metrics endpoint is down
        - alert: ImmichServerDown
          expr: up{job="immich-metrics"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Immich server is down"
            description: "Immich metrics endpoint {{ $labels.instance }} is not responding"

        # Alert if thumbnail generation queue is saturated (active for 10+ minutes)
        - alert: ImmichThumbnailQueueStuck
          expr: immich_queues_thumbnail_generation_active > 0
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Immich thumbnail queue appears stuck"
            description: "Thumbnail generation has been active for over 10 minutes ({{ $value }} jobs)"

        # Alert if video conversion queue is saturated
        - alert: ImmichVideoQueueStuck
          expr: immich_queues_video_conversion_active > 0
          for: 30m
          labels:
            severity: warning
          annotations:
            summary: "Immich video conversion queue appears stuck"
            description: "Video conversion has been active for over 30 minutes ({{ $value }} jobs)"

        # Alert if metadata extraction queue is saturated
        - alert: ImmichMetadataQueueStuck
          expr: immich_queues_metadata_extraction_active > 0
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Immich metadata extraction appears stuck"
            description: "Metadata extraction has been active for over 15 minutes ({{ $value }} jobs)"

        # Alert if no thumbnails generated recently (possible processing issue)
        - alert: ImmichNoThumbnailActivity
          expr: increase(immich_jobs_asset_generate_thumbnails_success_total[6h]) == 0
          for: 1h
          labels:
            severity: info
          annotations:
            summary: "No Immich thumbnail activity in 6+ hours"
            description: "No thumbnails have been generated in over 6 hours - may indicate no uploads or processing issues"

        # Alert on high database query latency (p99 > 1s)
        - alert: ImmichDatabaseSlowQueries
          expr: |
            histogram_quantile(0.99,
              sum by (le) (rate(immich_asset_repository_get_by_id_duration_bucket[5m]))
            ) > 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Immich database queries are slow"
            description: "99th percentile asset lookup latency is {{ $value | humanizeDuration }}"
