apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-entrypoint
  namespace: private-exit-node
data:
  entrypoint.sh: |
    #!/bin/bash
    set -euo pipefail

    echo "=== Private Exit Node Gateway ==="
    echo "Mode: ${TUNNEL_MODE}"

    # --- Start obfuscation tunnel ---
    case "${TUNNEL_MODE}" in
      shadowsocks)
        echo "Starting Shadowsocks tunnel (primary)"
        mkdir -p /etc/shadowsocks
        cat > /etc/shadowsocks/config.json <<SSEOF
    {
      "locals": [
        {
          "local_address": "127.0.0.1",
          "local_port": 51820,
          "forward_address": "127.0.0.1",
          "forward_port": 51820,
          "protocol": "tunnel",
          "mode": "udp_only"
        }
      ],
      "server": "${VPS_IP}",
      "server_port": 443,
      "password": "${SS_PASSWORD}",
      "method": "2022-blake3-aes-256-gcm",
      "udp_over_tcp": true
    }
    SSEOF
        sslocal -c /etc/shadowsocks/config.json &
        ;;
      wstunnel)
        echo "Starting wstunnel (fallback)"
        wstunnel client \
          -L "udp://127.0.0.1:51820:127.0.0.1:51820" \
          "wss://${VPS_IP}:8443" &
        ;;
      *)
        echo "ERROR: Unknown TUNNEL_MODE: ${TUNNEL_MODE}"
        exit 1
        ;;
    esac

    TUNNEL_PID=$!
    echo "Tunnel PID: ${TUNNEL_PID}"
    sleep 3

    # --- Set up WireGuard manually (avoids wg-quick sysctl issues) ---
    echo "${WG_PRIVATE_KEY}" > /tmp/wg-private-key
    ip link add wg0 type wireguard
    wg set wg0 \
      private-key /tmp/wg-private-key \
      peer "${WG_PEER_PUBLIC_KEY}" \
      endpoint 127.0.0.1:51820 \
      allowed-ips 0.0.0.0/0 \
      persistent-keepalive 25
    rm -f /tmp/wg-private-key
    ip addr add 10.66.66.2/24 dev wg0
    ip link set wg0 up
    echo "WireGuard interface up"

    # --- Policy routing: only forward LAN traffic through VPN ---
    # Route table 100 sends traffic via WireGuard
    ip route add default via 10.66.66.1 dev wg0 table 100

    # Mark forwarded LAN traffic, route it through VPN table
    iptables -t mangle -A PREROUTING -s 192.168.1.0/24 -j MARK --set-mark 100
    ip rule add fwmark 100 table 100

    # NAT: masquerade LAN traffic going through the tunnel
    iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o wg0 -j MASQUERADE

    # --- Block IPv6 forwarding to prevent leaks ---
    ip6tables -P FORWARD DROP

    echo "=== Gateway active (mode: ${TUNNEL_MODE}) ==="

    # Keep running - wait on tunnel process
    wait ${TUNNEL_PID}
